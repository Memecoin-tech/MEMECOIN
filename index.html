<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meme Coin Paper Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .trade-card, .calendar-day, .recap-card {
            transition: all 0.3s ease;
        }
        .trade-card.new, .page.new, .recap-card.new {
            animation: slide-down 0.5s ease-out forwards;
        }
        @keyframes slide-down {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .nav-link.active {
            color: #22d3ee; /* cyan-400 */
            border-bottom: 2px solid #22d3ee;
        }
        .calendar-day:not(.empty):hover {
            background-color: #374151; /* gray-700 */
        }
        #tooltip, #recap-modal {
            z-index: 100;
        }
        #tooltip {
            pointer-events: none;
        }
        .modal-content {
            max-height: 80vh;
        }
        .recap-card-inner {
            padding-top: 125%; /* 4:5 Aspect Ratio (5/4 * 100) */
            position: relative;
        }
        .recap-card-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
        }
        .preserve-whitespace {
            white-space: pre-wrap;
            word-break: break-word;
        }
        .recap-text-content::-webkit-scrollbar {
            width: 6px;
        }
        .recap-text-content::-webkit-scrollbar-track {
            background: transparent;
        }
        .recap-text-content::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 3px;
        }
        .view-toggle-btn.active {
            background-color: #0891b2; /* cyan-600 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-6">

    <!-- SOL Price Ticker -->
    <div id="sol-price-ticker" class="fixed top-4 left-4 flex items-center bg-gray-800/80 backdrop-blur-sm p-2 rounded-lg shadow-lg z-50 transition-transform duration-300 ease-in-out">
        <svg class="w-6 h-6 mr-2" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="a"><stop stop-color="#00FFA3" offset="0%"></stop><stop stop-color="#DC1FFF" offset="100%"></stop></linearGradient></defs><g fill="none" fill-rule="evenodd"><path d="M20 40c11.046 0 20-8.954 20-20S31.046 0 20 0 0 8.954 0 20s8.954 20 20 20z" fill="url(#a)"></path><path d="M11.07 13.243h17.86v3.214h-17.86zM11.07 18.214h17.86v3.215h-17.86zM11.07 23.186h11.9v3.214h-11.9z" fill="#FFF" fill-rule="nonzero"></path></g></svg>
        <span id="sol-price-value" class="text-lg font-bold text-white">Loading...</span>
    </div>

    <div class="w-full max-w-4xl mx-auto mt-16 sm:mt-0">
        <!-- Header & Navigation -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400">Meme Coin Paper Trading</h1>
            <nav class="mt-4 text-lg space-x-2 sm:space-x-4">
                <a href="#home" id="nav-home" class="nav-link active px-3 py-2">Home</a>
                <a href="#recap" id="nav-recap" class="nav-link px-3 py-2">Daily Recap</a>
                <a href="#portfolio" id="nav-portfolio" class="nav-link px-3 py-2">Portfolio</a>
                <a href="#journal" id="nav-journal" class="nav-link px-3 py-2">Journal</a>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Home Page (Trade Logger) -->
            <div id="page-home" class="page">
                <!-- Trade Form -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-center">Log a New Trade</h2>
                    <form id="trade-form" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-3"><label for="coin-name" class="block text-sm font-medium text-gray-300 mb-1">Coin Name/Ticker</label><input type="text" id="coin-name" placeholder="e.g., PEPE" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" required></div>
                        <div><label for="buy-cap" class="block text-sm font-medium text-gray-300 mb-1">Buy MC ($)</label><input type="text" id="buy-cap" placeholder="e.g., 100k" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" required></div>
                        <div><label for="sell-cap" class="block text-sm font-medium text-gray-300 mb-1">Sell MC ($)</label><input type="text" id="sell-cap" placeholder="e.g., 500k" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" required></div>
                        <div><div class="flex justify-between items-center mb-1"><label for="investment-amount" class="block text-sm font-medium text-gray-300">Investment</label><button type="button" id="currency-toggle-btn" class="text-xs bg-gray-600 hover:bg-gray-500 text-cyan-300 font-semibold py-1 px-2 rounded-md">SOL</button></div><input type="number" id="investment-amount" step="any" placeholder="e.g., 0.5" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" required></div>
                        <div class="sm:col-span-3"><button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md">Add Trade</button></div>
                    </form>
                </div>
                <!-- Trades List -->
                <div id="trades-container" class="space-y-4">
                    <h3 class="text-lg font-semibold text-center text-gray-400" id="no-trades-message">No trades logged for this session yet.</h3>
                </div>
                <!-- Session Summary -->
                <div class="mt-8 flex flex-col items-center">
                     <button id="calculate-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 shadow-lg disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Calculate Session P/L</button>
                     <div id="summary" class="mt-6 bg-gray-800 p-6 rounded-xl shadow-lg w-full text-center hidden"><h2 class="text-xl font-semibold mb-4 text-cyan-400">Session Summary</h2><div class="grid grid-cols-1 sm:grid-cols-3 gap-4"><div><p class="text-gray-400 text-sm">Total PNL</p><p id="total-pnl" class="text-2xl font-bold">$0</p></div><div><p class="text-gray-400 text-sm">Average ROI</p><p id="average-roi" class="text-2xl font-bold">0%</p></div><div><p class="text-gray-400 text-sm">Compounded Multiplier</p><p id="compounded-multiplier" class="text-2xl font-bold">0x</p></div></div></div>
                </div>
            </div>

            <!-- Portfolio Page (Calendar & Graph) -->
            <div id="page-portfolio" class="page hidden">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <div id="calendar-header" class="flex justify-between items-center mb-4">
                        <div class="flex items-center">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-700">&lt;</button>
                            <h2 id="month-year-label" class="text-xl font-bold text-cyan-400 mx-4"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-700">&gt;</button>
                        </div>
                        <div class="flex items-center space-x-2 bg-gray-700 p-1 rounded-lg">
                            <button id="calendar-view-btn" class="view-toggle-btn active p-2 rounded-md hover:bg-cyan-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button id="graph-view-btn" class="view-toggle-btn p-2 rounded-md hover:bg-cyan-700">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11h1.447a1 1 0 00.894-.553l2.863-6.72 1.514 4.542a1 1 0 00.894.553h2.772a1 1 0 00.894-.553l2.863-6.72 1.514 4.542a1 1 0 00.894.553H18a1 1 0 100-2h-1.447a1 1 0 00-.894.553l-2.863 6.72-1.514-4.542a1 1 0 00-.894-.553H7.228a1 1 0 00-.894.553l-2.863 6.72-1.514-4.542a1 1 0 00-.894-.553H2a1 1 0 100 2z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                    <div id="graph-container" class="hidden"><canvas id="pnl-chart"></canvas></div>
                </div>
            </div>

            <!-- Daily Recap Page -->
            <div id="page-recap" class="page hidden">
                 <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-8 flex justify-between items-center">
                    <h2 class="text-xl font-semibold">Daily Recaps</h2>
                    <div class="flex items-center space-x-2">
                        <input type="date" id="recap-filter-date" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1.5 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                        <button id="clear-recap-filter-btn" class="hidden bg-gray-600 hover:bg-gray-500 text-white font-bold py-1.5 px-3 rounded-lg">Show All</button>
                    </div>
                </div>
                 <div id="recaps-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <h3 class="text-lg font-semibold text-center text-gray-400 col-span-full" id="no-recaps-message">Loading Recaps...</h3>
                </div>
            </div>

            <!-- Journal Page -->
            <div id="page-journal" class="page hidden">
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-center">Journal</h2>
                    <textarea id="journal-textarea" class="w-full h-96 bg-gray-700 border border-gray-600 rounded-lg p-4 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="Write your thoughts here..."></textarea>
                    <div class="mt-4 flex justify-between items-center">
                        <button id="prev-page-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50" disabled>&lt; Prev</button>
                        <span id="page-indicator" class="text-gray-400">Page 1</span>
                        <button id="next-page-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Next &gt;</button>
                    </div>
                    <div class="mt-4 text-center">
                        <button id="save-journal-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Save Journal</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="w-full mt-12 py-8 border-t border-gray-800">
        <div class="max-w-4xl mx-auto px-4 relative">
            <div class="text-center">
                <p class="text-gray-400">Your Support Keeps Us Online. Any Amount will be Appreciated</p>
                <div id="donation-box" class="group mt-4 bg-gray-800/50 hover:bg-gray-700/70 transition-colors duration-300 rounded-lg p-6 max-w-lg mx-auto cursor-pointer" title="Click to copy address">
                    <p class="text-gray-300 mb-2">Donate Solana</p>
                    <div id="copy-address-container" class="relative">
                        <p id="solana-address" class="font-mono text-cyan-400 group-hover:text-cyan-300 transition-colors duration-300 break-all">7gbYLotH2vaBaoY18mHoeUfz5q79rFxMtmUcfvezMc4Y</p>
                        <span id="copy-feedback" class="absolute -top-8 left-1/2 -translate-x-1/2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-md hidden">Copied!</span>
                    </div>
                </div>
            </div>
            <!-- Socials Link -->
            <div class="absolute bottom-0 right-4">
                <a href="https://x.com/MemecoinTech" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors duration-300">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                </a>
            </div>
        </div>
    </footer>


    <!-- Tooltip Element -->
    <div id="tooltip" class="hidden absolute bg-gray-600 text-white text-sm rounded-md px-2 py-1 shadow-lg"></div>

    <!-- Recap Modal -->
    <div id="recap-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="modal-recap-date" class="text-xl font-bold text-cyan-400"></h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto recap-text-content">
                 <p id="modal-recap-content" class="preserve-whitespace"></p>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================================
        // --- STATE MANAGEMENT ---
        // These variables hold the application's data and current state.
        // ===================================================================================
        let trades = []; // Array to store all trade objects
        let currentPage = 'home'; // Tracks the currently visible page ('home', 'portfolio', 'recap')
        let calendarDate = new Date(); // The date used for the portfolio calendar/graph view
        let investmentCurrency = 'SOL'; // The currency for the investment input ('SOL' or 'USD')
        let solPriceUSD = 195; // Holds the current price of SOL in USD, updated via API
        let pnlChart = null; // Holds the Chart.js instance for the PNL graph
        let portfolioView = 'calendar'; // Tracks the current view in the portfolio section ('calendar' or 'graph')
        const GIST_USERNAME = 'Memecoin-tech'; // The GitHub username to fetch Gists from
        let parsedRecaps = []; // A cache for the parsed recap data from the Gist
        let journalPages = ['']; // Array to store content for each journal page
        let currentJournalPage = 0; // Index of the current journal page (0-based)

        // ===================================================================================
        // --- DOM ELEMENT REFERENCES ---
        // Caching references to frequently used HTML elements for better performance.
        // ===================================================================================
        const navHome = document.getElementById('nav-home');
        const navPortfolio = document.getElementById('nav-portfolio');
        const navRecap = document.getElementById('nav-recap');
        const navJournal = document.getElementById('nav-journal');
        const pageHome = document.getElementById('page-home');
        const pagePortfolio = document.getElementById('page-portfolio');
        const pageRecap = document.getElementById('page-recap');
        const pageJournal = document.getElementById('page-journal');
        
        const tradeForm = document.getElementById('trade-form');
        const coinNameInput = document.getElementById('coin-name');
        const buyCapInput = document.getElementById('buy-cap');
        const sellCapInput = document.getElementById('sell-cap');
        const investmentAmountInput = document.getElementById('investment-amount');
        const currencyToggleBtn = document.getElementById('currency-toggle-btn');
        
        const tradesContainer = document.getElementById('trades-container');
        const noTradesMessage = document.getElementById('no-trades-message');
        
        const calculateBtn = document.getElementById('calculate-btn');
        const summaryDiv = document.getElementById('summary');
        const totalPnlEl = document.getElementById('total-pnl');
        const averageRoiEl = document.getElementById('average-roi');
        const compoundedMultiplierEl = document.getElementById('compounded-multiplier');

        const calendarHeader = document.getElementById('calendar-header');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const monthYearLabel = document.getElementById('month-year-label');
        const calendarGrid = document.getElementById('calendar-grid');
        const graphContainer = document.getElementById('graph-container');
        const calendarViewBtn = document.getElementById('calendar-view-btn');
        const graphViewBtn = document.getElementById('graph-view-btn');
        const tooltip = document.getElementById('tooltip');
        const solPriceValueEl = document.getElementById('sol-price-value');
        
        const recapsContainer = document.getElementById('recaps-container');
        const noRecapsMessage = document.getElementById('no-recaps-message');
        const recapFilterDate = document.getElementById('recap-filter-date');
        const clearRecapFilterBtn = document.getElementById('clear-recap-filter-btn');
        
        const recapModal = document.getElementById('recap-modal');
        const modalRecapDate = document.getElementById('modal-recap-date');
        const modalRecapContent = document.getElementById('modal-recap-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const journalTextarea = document.getElementById('journal-textarea');
        const saveJournalBtn = document.getElementById('save-journal-btn');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const pageIndicator = document.getElementById('page-indicator');

        // ===================================================================================
        // --- API & UTILITY FUNCTIONS ---
        // Helper functions for fetching data, parsing inputs, and formatting values.
        // ===================================================================================

        /**
         * Fetches the current price of Solana from the CoinGecko API.
         * Updates the price ticker and the global `solPriceUSD` variable.
         * @function fetchSolPrice
         */
        async function fetchSolPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                solPriceUSD = data.solana.usd;
                solPriceValueEl.textContent = `$${solPriceUSD.toFixed(2)}`;
            } catch (error) {
                console.error("Failed to fetch SOL price:", error);
                solPriceValueEl.textContent = 'Error';
            }
        } // --- End of fetchSolPrice ---

        /**
         * Parses a string with 'k' (thousands) or 'm' (millions) suffixes into a number.
         * @param {string} value - The string to parse (e.g., "100k", "1.5m").
         * @returns {number} The parsed numeric value.
         * @function parseMarketCap
         */
        function parseMarketCap(value) {
            const str = String(value).trim().toLowerCase();
            if (!str) return NaN;
            const lastChar = str.slice(-1);
            const numPart = str.slice(0, -1);
            const num = parseFloat(numPart);
            if (lastChar === 'k') return num * 1000;
            if (lastChar === 'm') return num * 1000000;
            return parseFloat(str);
        } // --- End of parseMarketCap ---

        /**
         * Formats a number into a compact currency string (e.g., +$1.2M, -$5.5K).
         * @param {number} amount - The numeric amount to format.
         * @returns {string} The formatted currency string.
         * @function formatCurrency
         */
        function formatCurrency(amount) {
            if (amount === 0) return '$0';
            const sign = amount > 0 ? '+' : '-';
            amount = Math.abs(amount);
            if (amount >= 1000000) return `${sign}$${(amount / 1000000).toFixed(1)}M`;
            if (amount >= 1000) return `${sign}$${(amount / 1000).toFixed(1)}K`;
            return `${sign}$${amount.toFixed(2)}`;
        } // --- End of formatCurrency ---
        
        // ===================================================================================
        // --- DATA PERSISTENCE ---
        // Functions to save and load data to/from the browser's localStorage.
        // ===================================================================================

        /**
         * Saves the current `trades` array to localStorage.
         * @function saveTrades
         */
        function saveTrades() { localStorage.setItem('meme_coin_trades', JSON.stringify(trades)); } // --- End of saveTrades ---

        /**
         * Loads the `trades` array from localStorage if it exists.
         * @function loadTrades
         */
        function loadTrades() { const d = localStorage.getItem('meme_coin_trades'); if(d) trades = JSON.parse(d); } // --- End of loadTrades ---

        /**
         * Saves the current page's content and the entire journal to localStorage.
         * @function saveJournal
         */
        function saveJournal() {
            journalPages[currentJournalPage] = journalTextarea.value;
            localStorage.setItem('trading_journal', JSON.stringify(journalPages));
            
            saveJournalBtn.textContent = 'Saved!';
            saveJournalBtn.classList.remove('bg-cyan-600', 'hover:bg-cyan-700');
            saveJournalBtn.classList.add('bg-green-600');
            setTimeout(() => {
                saveJournalBtn.textContent = 'Save Journal';
                saveJournalBtn.classList.remove('bg-green-600');
                saveJournalBtn.classList.add('bg-cyan-600', 'hover:bg-cyan-700');
            }, 1500);
        }

        /**
         * Loads the journal pages from localStorage.
         * @function loadJournal
         */
        function loadJournal() {
            const content = localStorage.getItem('trading_journal');
            if (content) {
                journalPages = JSON.parse(content);
                if (!Array.isArray(journalPages) || journalPages.length === 0) {
                    journalPages = [''];
                }
            } else {
                journalPages = [''];
            }
        }

        // ===================================================================================
        // --- PAGE NAVIGATION ---
        // Logic for switching between the different pages of the application.
        // ===================================================================================

        /**
         * Handles the logic for showing/hiding pages and updating navigation link styles.
         * @param {string} page - The name of the page to navigate to ('home', 'portfolio', 'recap').
         * @function navigate
         */
        function navigate(page) {
            currentPage = page;
            pageHome.classList.toggle('hidden', page !== 'home');
            pagePortfolio.classList.toggle('hidden', page !== 'portfolio');
            pageRecap.classList.toggle('hidden', page !== 'recap');
            pageJournal.classList.toggle('hidden', page !== 'journal');
            
            navHome.classList.toggle('active', page === 'home');
            navPortfolio.classList.toggle('active', page === 'portfolio');
            navRecap.classList.toggle('active', page === 'recap');
            navJournal.classList.toggle('active', page === 'journal');

            if (page === 'portfolio') updatePortfolioView();
            if (page === 'recap') fetchAndRenderRecaps();
        } // --- End of navigate ---
        
        // ===================================================================================
        // --- HOME PAGE LOGIC ---
        // Functions related to adding, displaying, and summarizing trades.
        // ===================================================================================

        /**
         * Renders the list of trades on the Home page.
         * @function renderTrades
         */
        function renderTrades() {
            tradesContainer.innerHTML = '';
            tradesContainer.appendChild(noTradesMessage);
            noTradesMessage.classList.toggle('hidden', trades.length > 0);
            calculateBtn.disabled = trades.length === 0;
            if (trades.length === 0) summaryDiv.classList.add('hidden');

            [...trades].reverse().forEach((trade) => {
                const tradeCard = document.createElement('div');
                tradeCard.className = 'trade-card bg-gray-800 p-4 rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-center gap-4 new';
                const pnlColor = trade.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                const originalIndex = trades.findIndex(t => t.id === trade.id);
                tradeCard.innerHTML = `<div class="text-center sm:text-left flex-grow"><p class="text-sm text-gray-400">${new Date(trade.date).toLocaleDateString()}</p><p class="text-lg font-bold text-cyan-300">${trade.coinName}</p><p class="font-mono text-sm">Buy: $${trade.buyCap.toLocaleString()} â†’ Sell: $${trade.sellCap.toLocaleString()}</p></div><div class="flex gap-4 sm:gap-6 text-center"><div><p class="text-sm text-gray-400">Investment</p><p class="text-lg font-bold">$${trade.investmentUSD.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div><div><p class="text-sm text-gray-400">PNL</p><p class="text-lg font-bold ${pnlColor}">${formatCurrency(trade.pnl)}</p></div><div><p class="text-sm text-gray-400">ROI</p><p class="text-lg font-bold ${pnlColor}">${trade.roi.toFixed(2)}%</p></div></div><button class="delete-btn text-gray-500 hover:text-red-500 transition-colors" data-index="${originalIndex}"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
                tradesContainer.appendChild(tradeCard);
                setTimeout(() => tradeCard.classList.remove('new'), 500);
            });
        } // --- End of renderTrades ---

        /**
         * Handles the submission of the new trade form.
         * @param {Event} e - The form submission event.
         * @function handleAddTrade
         */
        function handleAddTrade(e) {
            e.preventDefault();
            const coinName = coinNameInput.value.trim().toUpperCase() || 'UNTITLED';
            const buyCap = parseMarketCap(buyCapInput.value);
            const sellCap = parseMarketCap(sellCapInput.value);
            let investmentAmount = parseFloat(investmentAmountInput.value);
            if (isNaN(buyCap) || isNaN(sellCap) || isNaN(investmentAmount) || buyCap <= 0 || investmentAmount <= 0) { alert("Please enter valid, positive numbers for all fields."); return; }
            const investmentUSD = investmentCurrency === 'SOL' ? investmentAmount * solPriceUSD : investmentAmount;
            const multiplier = sellCap / buyCap;
            const pnl = investmentUSD * (multiplier - 1);
            trades.push({ id: Date.now(), date: new Date().toISOString(), coinName, buyCap, sellCap, investmentUSD, multiplier, roi: (multiplier - 1) * 100, pnl });
            saveTrades();
            renderTrades();
            tradeForm.reset();
            coinNameInput.focus();
            summaryDiv.classList.add('hidden');
        } // --- End of handleAddTrade ---
        
        /**
         * Deletes a trade from the `trades` array when the delete button is clicked.
         * @param {Event} e - The click event.
         * @function handleDeleteTrade
         */
        function handleDeleteTrade(e) {
            if (e.target.closest('.delete-btn')) {
                const button = e.target.closest('.delete-btn');
                trades.splice(parseInt(button.dataset.index, 10), 1);
                saveTrades();
                renderTrades();
                summaryDiv.classList.add('hidden');
            }
        } // --- End of handleDeleteTrade ---

        /**
         * Calculates and displays the session summary statistics.
         * @function handleCalculateSummary
         */
        function handleCalculateSummary() {
            if (trades.length === 0) return;
            const totalPnl = trades.reduce((sum, trade) => sum + trade.pnl, 0);
            const totalInvestment = trades.reduce((sum, trade) => sum + trade.investmentUSD, 0);
            const averageRoi = totalInvestment > 0 ? (totalPnl / totalInvestment) * 100 : 0;
            const compoundedMultiplier = trades.reduce((product, trade) => product * trade.multiplier, 1);
            totalPnlEl.textContent = formatCurrency(totalPnl);
            averageRoiEl.textContent = `${averageRoi.toFixed(2)}%`;
            compoundedMultiplierEl.textContent = `${compoundedMultiplier.toFixed(2)}x`;
            const pnlColor = totalPnl >= 0 ? 'text-green-400' : 'text-red-400';
            totalPnlEl.className = `text-2xl font-bold ${pnlColor}`;
            averageRoiEl.className = `text-2xl font-bold ${pnlColor}`;
            compoundedMultiplierEl.className = `text-2xl font-bold ${compoundedMultiplier >= 1 ? 'text-green-400' : 'text-red-400'}`;
            summaryDiv.classList.remove('hidden');
        } // --- End of handleCalculateSummary ---

        /**
         * Toggles the investment currency between SOL and USD.
         * @function toggleCurrency
         */
        function toggleCurrency() {
            investmentCurrency = (investmentCurrency === 'SOL') ? 'USD' : 'SOL';
            currencyToggleBtn.textContent = investmentCurrency;
            investmentAmountInput.placeholder = investmentCurrency === 'SOL' ? 'e.g., 0.5' : 'e.g., 100.50';
        } // --- End of toggleCurrency ---

        // ===================================================================================
        // --- PORTFOLIO PAGE LOGIC ---
        // Functions for displaying the calendar and P/L graph.
        // ===================================================================================

        /**
         * Switches between the calendar and graph views in the portfolio section.
         * @function updatePortfolioView
         */
        function updatePortfolioView() {
            calendarViewBtn.classList.toggle('active', portfolioView === 'calendar');
            graphViewBtn.classList.toggle('active', portfolioView === 'graph');
            calendarGrid.classList.toggle('hidden', portfolioView !== 'calendar');
            graphContainer.classList.toggle('hidden', portfolioView !== 'graph');

            if (portfolioView === 'calendar') {
                renderCalendar();
            } else {
                renderPnlChart();
            }
        } // --- End of updatePortfolioView ---

        /**
         * Renders the calendar view for the currently selected month.
         * @function renderCalendar
         */
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            monthYearLabel.textContent = calendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(label => {
                const labelEl = document.createElement('div');
                labelEl.className = 'text-center text-gray-500 text-sm font-bold';
                labelEl.textContent = label;
                calendarGrid.appendChild(labelEl);
            });
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) calendarGrid.appendChild(document.createElement('div'));
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                const tradesForDay = trades.filter(t => { const d = new Date(t.date); return d.getFullYear() === year && d.getMonth() === month && d.getDate() === day; });
                const pnl = tradesForDay.reduce((sum, trade) => sum + trade.pnl, 0);
                const pnlColor = pnl > 0 ? 'bg-green-500/20 text-green-300' : pnl < 0 ? 'bg-red-500/20 text-red-300' : 'text-gray-400';
                dayCell.className = `calendar-day border border-gray-700 rounded-md p-2 h-24 flex flex-col justify-between ${pnlColor}`;
                dayCell.innerHTML = `<span class="font-bold">${day}</span><span class="text-sm font-semibold self-end">${pnl !== 0 ? formatCurrency(pnl) : '$0'}</span>`;
                if (tradesForDay.length > 0) dayCell.dataset.tradeCount = tradesForDay.length;
                calendarGrid.appendChild(dayCell);
            }
        } // --- End of renderCalendar ---
        
        /**
         * Renders the cumulative P/L chart for the currently selected month.
         * @function renderPnlChart
         */
        function renderPnlChart() {
            if (pnlChart) {
                pnlChart.destroy();
            }
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const dailyPnl = new Array(daysInMonth).fill(0);

            trades.forEach(trade => {
                const tradeDate = new Date(trade.date);
                if (tradeDate.getFullYear() === year && tradeDate.getMonth() === month) {
                    dailyPnl[tradeDate.getDate() - 1] += trade.pnl;
                }
            });

            const cumulativePnl = dailyPnl.reduce((acc, pnl, i) => {
                acc.push((acc[i - 1] || 0) + pnl);
                return acc;
            }, []);

            const ctx = document.getElementById('pnl-chart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            const lastPnl = cumulativePnl[cumulativePnl.length - 1] || 0;
            if (lastPnl >= 0) {
                gradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)');
                gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');
            } else {
                gradient.addColorStop(0, 'rgba(239, 68, 68, 0.5)');
                gradient.addColorStop(1, 'rgba(239, 68, 68, 0)');
            }

            pnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative P/L',
                        data: cumulativePnl,
                        borderColor: lastPnl >= 0 ? '#10B981' : '#EF4444',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: lastPnl >= 0 ? '#10B981' : '#EF4444',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` P/L: ${context.raw.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}`;
                                },
                                title: function(context) {
                                    return `${calendarDate.toLocaleString('default', { month: 'long' })} ${context[0].label}, ${year}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#9CA3AF' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#9CA3AF' },
                            grid: { display: false }
                        }
                    }
                }
            });
        } // --- End of renderPnlChart ---

        // ===================================================================================
        // --- DAILY RECAP LOGIC (FIXED) ---
        // Functions for fetching, parsing, and displaying recaps from the universal Gist.
        // ===================================================================================

        /**
         * Fetches data from public Gists, parses them, and renders recap posts.
         * Implements caching to avoid hitting GitHub API rate limits.
         * @param {string|null} filterDate - An optional date string (YYYY-MM-DD) to filter recaps.
         * @function fetchAndRenderRecaps
         */
        async function fetchAndRenderRecaps(filterDate = null) {
            recapsContainer.innerHTML = '';
            noRecapsMessage.textContent = 'Loading Recaps...';
            recapsContainer.appendChild(noRecapsMessage);

            // Check for cached data first to avoid hitting API rate limits.
            const cachedRecaps = localStorage.getItem('cached_recaps');
            const cacheTimestamp = localStorage.getItem('cached_recaps_timestamp');
            const now = new Date().getTime();
            const fiveMinutes = 5 * 60 * 1000;

            // Use cache if it's less than 5 minutes old
            if (cachedRecaps && cacheTimestamp && (now - parseInt(cacheTimestamp, 10) < fiveMinutes)) {
                console.log("Using cached recap data.");
                parsedRecaps = JSON.parse(cachedRecaps);
            } else {
                console.log("Fetching new recap data from GitHub.");
                try {
                    // Step 1: Fetch the list of all public Gists for the user.
                    const listResponse = await fetch(`https://api.github.com/users/${GIST_USERNAME}/gists`);
                    if (!listResponse.ok) {
                        if (listResponse.status === 403) throw new Error('GitHub API rate limit exceeded. Please try again in a few minutes.');
                        if (listResponse.status === 404) throw new Error(`GitHub user '${GIST_USERNAME}' not found.`);
                        throw new Error(`Could not fetch Gist list from GitHub. Status: ${listResponse.status}`);
                    }
                    const gistsList = await listResponse.json();
                    
                    // Step 2: Fetch details for each Gist to get content.
                    const detailPromises = gistsList.map(gist => 
                        fetch(gist.url).then(res => {
                            if (!res.ok) {
                                console.warn(`Failed to fetch details for Gist ${gist.id}, skipping.`);
                                return null; // Don't fail the whole operation
                            }
                            return res.json();
                        })
                    );
                    const detailedGists = (await Promise.all(detailPromises)).filter(g => g !== null);

                    // Step 3: Parse the content from the detailed Gists.
                    parsedRecaps = detailedGists.map(gistDetail => {
                        const file = Object.values(gistDetail.files)[0];
                        if (!file || !file.content) return null;
                        
                        const content = file.content;
                        const lines = content.trim().split('\n');
                        const dateLine = lines.shift();
                        const recapContent = lines.join('\n').trim();

                        let recapDate = new Date(dateLine);
                        if (isNaN(recapDate.getTime())) {
                            recapDate = new Date(gistDetail.created_at);
                        }

                        return { id: gistDetail.id, date: recapDate.toISOString(), content: recapContent };
                    }).filter(recap => recap && recap.content);

                    // Cache the newly fetched data
                    localStorage.setItem('cached_recaps', JSON.stringify(parsedRecaps));
                    localStorage.setItem('cached_recaps_timestamp', now.toString());
                    console.log("Fetched and cached new recap data.");

                } catch (error) {
                    noRecapsMessage.textContent = `Error: ${error.message}`;
                    console.error("Error fetching or parsing Gists:", error);
                    return; // Stop execution if fetching fails
                }
            }
            
            // --- Rendering Logic (runs with either cached or new data) ---
            let recapsToDisplay = [...parsedRecaps];
            if (filterDate) {
                const targetDate = new Date(filterDate);
                recapsToDisplay = parsedRecaps.filter(recap => {
                    const recapDate = new Date(recap.date);
                    return recapDate.getFullYear() === targetDate.getFullYear() &&
                           recapDate.getMonth() === targetDate.getMonth() &&
                           recapDate.getDate() === targetDate.getDate();
                });
            }

            recapsContainer.innerHTML = ''; // Clear previous content
            noRecapsMessage.classList.toggle('hidden', recapsToDisplay.length > 0);
            if (recapsToDisplay.length === 0) {
                noRecapsMessage.textContent = filterDate ? 'No recap found for this date.' : 'No recaps found.';
                recapsContainer.appendChild(noRecapsMessage);
            }
            
            const sortedRecaps = recapsToDisplay.sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedRecaps.forEach(recap => {
                const recapCard = document.createElement('div');
                recapCard.className = 'recap-card bg-gray-800 rounded-lg shadow-md cursor-pointer hover:bg-gray-700 new overflow-hidden';
                recapCard.dataset.recapId = recap.id;
                
                const displayDate = new Date(recap.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });

                recapCard.innerHTML = `
                    <div class="recap-card-inner">
                         <div class="recap-card-content p-4">
                            <h4 class="font-bold text-cyan-300 mb-2">${displayDate}</h4>
                            <p class="text-gray-300 text-sm flex-grow overflow-y-auto recap-text-content preserve-whitespace">${recap.content}</p>
                        </div>
                    </div>
                `;
                recapsContainer.appendChild(recapCard);
                setTimeout(() => recapCard.classList.remove('new'), 500);
            });
        }
        
        /**
         * Opens the modal to display the full content of a recap post.
         * @param {object} recap - The recap object to display.
         * @function openRecapModal
         */
        function openRecapModal(recap) {
            const displayDate = new Date(recap.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
            modalRecapDate.textContent = displayDate;
            modalRecapContent.textContent = recap.content;
            recapModal.classList.remove('hidden');
        } // --- End of openRecapModal ---

        /**
         * Closes the recap modal.
         * @function closeRecapModal
         */
        function closeRecapModal() {
            recapModal.classList.add('hidden');
        } // --- End of closeRecapModal ---

        /**
         * Displays the content of the current journal page.
         * @function displayJournalPage
         */
        function displayJournalPage() {
            journalTextarea.value = journalPages[currentJournalPage] || '';
            pageIndicator.textContent = `Page ${currentJournalPage + 1}`;
            prevPageBtn.disabled = currentJournalPage === 0;
            prevPageBtn.classList.toggle('opacity-50', currentJournalPage === 0);
        }

        /**
         * Handles clicking the 'Next Page' button.
         * @function handleNextPage
         */
        function handleNextPage() {
            journalPages[currentJournalPage] = journalTextarea.value;
            currentJournalPage++;
            if (currentJournalPage >= journalPages.length) {
                journalPages.push('');
            }
            displayJournalPage();
        }

        /**
         * Handles clicking the 'Previous Page' button.
         * @function handlePrevPage
         */
        function handlePrevPage() {
            if (currentJournalPage > 0) {
                journalPages[currentJournalPage] = journalTextarea.value;
                currentJournalPage--;
                displayJournalPage();
            }
        }
        
        // ===================================================================================
        // --- EVENT LISTENERS ---
        // Attaching functions to user interactions (clicks, form submissions, etc.).
        // ===================================================================================

        // Navigation
        navHome.addEventListener('click', () => navigate('home'));
        navPortfolio.addEventListener('click', () => navigate('portfolio'));
        navRecap.addEventListener('click', () => navigate('recap'));
        navJournal.addEventListener('click', () => navigate('journal'));
        
        // Home Page
        currencyToggleBtn.addEventListener('click', toggleCurrency);
        tradeForm.addEventListener('submit', handleAddTrade);
        tradesContainer.addEventListener('click', handleDeleteTrade);
        calculateBtn.addEventListener('click', handleCalculateSummary);

        // Recap Page
        recapsContainer.addEventListener('click', (e) => {
            const card = e.target.closest('.recap-card');
            if (card) {
                const recap = parsedRecaps.find(r => r.id === card.dataset.recapId);
                if (recap) {
                    openRecapModal(recap);
                }
            }
        });
        
        recapFilterDate.addEventListener('change', (e) => {
            const date = e.target.value;
            fetchAndRenderRecaps(date || null);
            clearRecapFilterBtn.classList.toggle('hidden', !date);
        });

        clearRecapFilterBtn.addEventListener('click', () => {
            recapFilterDate.value = '';
            fetchAndRenderRecaps();
            clearRecapFilterBtn.classList.add('hidden');
        });

        // Portfolio Page
        prevMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); updatePortfolioView(); });
        nextMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); updatePortfolioView(); });
        calendarViewBtn.addEventListener('click', () => { portfolioView = 'calendar'; updatePortfolioView(); });
        graphViewBtn.addEventListener('click', () => { portfolioView = 'graph'; updatePortfolioView(); });

        calendarGrid.addEventListener('mouseover', (e) => { const c = e.target.closest('.calendar-day'); if (c && c.dataset.tradeCount) { tooltip.textContent = `${c.dataset.tradeCount} trade${c.dataset.tradeCount > 1 ? 's' : ''}`; tooltip.classList.remove('hidden'); } });
        calendarGrid.addEventListener('mouseout', () => tooltip.classList.add('hidden'));
        calendarGrid.addEventListener('mousemove', (e) => { if (!tooltip.classList.contains('hidden')) { tooltip.style.left = `${e.pageX + 15}px`; tooltip.style.top = `${e.pageY + 15}px`; } });

        // Modal
        modalCloseBtn.addEventListener('click', closeRecapModal);
        
        // Journal Page
        saveJournalBtn.addEventListener('click', saveJournal);
        prevPageBtn.addEventListener('click', handlePrevPage);
        nextPageBtn.addEventListener('click', handleNextPage);

        // ===================================================================================
        // --- FOOTER LOGIC ---
        // Handles the copy-to-clipboard functionality for the donation address.
        // ===================================================================================
        const donationBox = document.getElementById('donation-box');
        const solanaAddressEl = document.getElementById('solana-address');
        const copyFeedbackEl = document.getElementById('copy-feedback');

        donationBox.addEventListener('click', () => {
            const address = solanaAddressEl.textContent;
            
            // Create a temporary textarea element to hold the address text
            const textArea = document.createElement('textarea');
            textArea.value = address;
            
            // Style it to be invisible and out of the way
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                // Execute the copy command
                const successful = document.execCommand('copy');
                if (successful) {
                    // Show "Copied!" feedback message
                    copyFeedbackEl.classList.remove('hidden');
                    // Hide the message after 2 seconds
                    setTimeout(() => {
                        copyFeedbackEl.classList.add('hidden');
                    }, 2000);
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }

            // Clean up and remove the temporary textarea
            document.body.removeChild(textArea);
        });
        
        // ===================================================================================
        // --- SCROLL BEHAVIOR ---
        // Hides the Solana price ticker when scrolling down and shows it when scrolling up.
        // ===================================================================================
        const solPriceTicker = document.getElementById('sol-price-ticker');
        let lastScrollY = window.scrollY;

        window.addEventListener('scroll', () => {
            if (solPriceTicker) {
                if (window.scrollY > lastScrollY && window.scrollY > 100) {
                    // Scrolling down past 100px
                    solPriceTicker.classList.add('-translate-y-[150%]');
                } else {
                    // Scrolling up
                    solPriceTicker.classList.remove('-translate-y-[150%]');
                }
            }
            // Update last scroll position, handle negative scroll on some browsers
            lastScrollY = window.scrollY <= 0 ? 0 : window.scrollY;
        });


        // ===================================================================================
        // --- INITIAL LOAD ---
        // The main function that runs when the application first starts.
        // ===================================================================================

        /**
         * Initializes the application on page load.
         * @function init
         */
        function init() {
            loadTrades();
            renderTrades();
            loadJournal();
            displayJournalPage();
            navigate('home');
            fetchSolPrice(); // Initial fetch
            setInterval(fetchSolPrice, 30000); // Fetch every 30 seconds
        } // --- End of init ---

        // Start the application
        init();
    </script>
</body>
</html>

